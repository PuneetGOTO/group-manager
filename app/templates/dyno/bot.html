{% extends 'base.html' %}

{% block title %}Discord机器人管理{% endblock %}

{% block styles %}
<style>
    .bot-card {
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .bot-card .card-header {
        border-radius: 10px 10px 0 0;
    }
    .bot-status {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
    }
    .status-online {
        background-color: #43b581;
    }
    .status-offline {
        background-color: #747f8d;
    }
    .status-error {
        background-color: #f04747;
    }
    .token-input {
        font-family: monospace;
    }
    .bot-actions {
        display: flex;
        gap: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">
        <i class="fas fa-robot me-2"></i> Discord机器人管理
    </h1>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i> 通过配置和启动Discord机器人，可以实现自动化管理Discord服务器的功能，包括自动审核、欢迎消息、自定义命令等。
    </div>
    
    <div class="row mt-4">
        <div class="col-md-8">
            <!-- 全局机器人配置 -->
            {% if current_user.is_admin %}
            <div class="card bot-card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i> 全局机器人配置
                    </h5>
                </div>
                <div class="card-body">
                    {% if global_bot %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-2">
                            <span class="bot-status status-{{ global_bot.status }}"></span>
                            <strong>状态:</strong> 
                            {% if global_bot.status == 'online' %}
                            <span class="text-success">在线</span>
                            {% elif global_bot.status == 'error' %}
                            <span class="text-danger">错误</span>
                            {% else %}
                            <span class="text-secondary">离线</span>
                            {% endif %}
                        </div>
                        <div class="ms-3">
                            <button class="btn btn-sm btn-outline-info check-status-btn" data-bot-id="{{ global_bot.id }}">
                                <i class="fas fa-sync-alt"></i> 检查状态
                            </button>
                        </div>
                    </div>
                    
                    {% if global_bot.error_message %}
                    <div class="alert alert-danger">
                        <strong>错误信息:</strong> {{ global_bot.error_message }}
                    </div>
                    {% endif %}
                    
                    <form action="{{ url_for('dyno.activate_bot') }}" method="post" class="mb-3">
                        <input type="hidden" name="bot_id" value="{{ global_bot.id }}">
                        <input type="hidden" name="group_id" value="{{ global_bot.group_id }}">
                        <div class="mb-3">
                            <label class="form-label">机器人令牌</label>
                            <div class="input-group">
                                <input type="password" class="form-control token-input" name="bot_token" 
                                       id="bot_token_{{ global_bot.id }}" data-bot-id="{{ global_bot.id }}" 
                                       placeholder="输入Discord机器人令牌" 
                                       value="{{ global_bot.bot_token if global_bot.bot_token else '' }}">
                                <button type="button" class="btn btn-outline-secondary toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">如不需要更改令牌，请留空</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">欢迎频道 <small class="text-muted">(可选，留空表示所有频道)</small></label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="channel_ids" id="welcome_channel_ids" placeholder="输入频道ID，多个ID用逗号分隔" value="{{ global_bot.channel_ids }}">
                                <button type="button" class="btn btn-outline-secondary select-channels-btn" data-target="welcome_channel_ids" data-bot-id="{{ global_bot.id }}">
                                    <i class="fas fa-list"></i> 选择频道
                                </button>
                                <span class="input-group-text selected-channels-display" id="welcome-channels-count">所有频道</span>
                            </div>
                            <div class="form-text">
                                <small>例如：123456789,987654321</small>
                            </div>
                        </div>
                        <div class="bot-actions">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-play me-1"></i> 激活机器人
                            </button>
                        </div>
                    </form>
                    
                    {% if global_bot.id %}
                    <form action="{{ url_for('dyno.deactivate_bot', bot_id=global_bot.id) }}" method="post" class="mt-2">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-stop me-1"></i> 停用机器人
                        </button>
                    </form>
                    {% endif %}
                    
                    <div class="mt-3 bot-info-container" data-bot-id="{{ global_bot.id }}">
                        {% if global_bot.status == 'online' %}
                        <div class="alert alert-success">
                            <strong>机器人信息:</strong> 
                            <span class="bot-name">加载中...</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% else %}
                    <!-- 没有全局机器人，显示创建表单 -->
                    <form action="{{ url_for('dyno.activate_bot') }}" method="post">
                        <input type="hidden" name="group_id" value="global">
                        <div class="mb-3">
                            <label class="form-label">机器人令牌</label>
                            <div class="input-group">
                                <input type="password" class="form-control token-input" name="bot_token" placeholder="输入Discord机器人令牌" required>
                                <button type="button" class="btn btn-outline-secondary toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">如不需要更改令牌，请留空</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">欢迎频道 <small class="text-muted">(可选，留空表示所有频道)</small></label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="channel_ids" id="welcome_channel_ids_new" placeholder="输入频道ID，多个ID用逗号分隔">
                                <button type="button" class="btn btn-outline-secondary select-channels-btn" data-target="welcome_channel_ids_new">
                                    <i class="fas fa-list"></i> 选择频道
                                </button>
                                <span class="input-group-text selected-channels-display">所有频道</span>
                            </div>
                            <div class="form-text">
                                <small>例如：123456789,987654321</small>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i> 创建并激活机器人
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- 群组机器人配置 -->
            <div class="card bot-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users-cog me-2"></i> 群组机器人配置
                    </h5>
                </div>
                <div class="card-body">
                    {% if group_bots %}
                    <ul class="list-group">
                        {% for bot in group_bots %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5>
                                    {% if bot.group %}
                                    <a href="{{ url_for('groups.view', group_id=bot.group.id) }}">{{ bot.group.name }}</a>
                                    {% else %}
                                    未关联群组
                                    {% endif %}
                                </h5>
                                <div>
                                    <span class="bot-status status-{{ bot.status }}"></span>
                                    {% if bot.status == 'online' %}
                                    <span class="text-success">在线</span>
                                    {% elif bot.status == 'error' %}
                                    <span class="text-danger">错误</span>
                                    {% else %}
                                    <span class="text-secondary">离线</span>
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-info ms-2 check-status-btn" data-bot-id="{{ bot.id }}">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            
                            {% if bot.error_message %}
                            <div class="alert alert-danger">
                                <strong>错误信息:</strong> {{ bot.error_message }}
                            </div>
                            {% endif %}
                            
                            <form action="{{ url_for('dyno.activate_bot') }}" method="post" class="mb-3">
                                <input type="hidden" name="bot_id" value="{{ bot.id }}">
                                <input type="hidden" name="group_id" value="{{ bot.group_id }}">
                                <div class="mb-3">
                                    <label class="form-label">机器人令牌</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control token-input" name="bot_token" 
                                               id="bot_token_{{ bot.id }}" data-bot-id="{{ bot.id }}" 
                                               placeholder="输入Discord机器人令牌" 
                                               value="{{ bot.bot_token if bot.bot_token else '' }}">
                                        <button type="button" class="btn btn-outline-secondary toggle-password">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">如不需要更改令牌，请留空</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">频道设置 <small class="text-muted">(可选，留空表示所有频道)</small></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="channel_ids" id="channel_ids_{{ bot.id }}" placeholder="输入频道ID，多个ID用逗号分隔" value="{{ bot.channel_ids }}">
                                        <div class="selected-channels-display form-text"></div>
                                        <button type="button" class="btn btn-outline-secondary select-channels-btn" data-target="channel_ids_{{ bot.id }}" data-bot-id="{{ bot.id }}">
                                            <i class="fas fa-list"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        <small>例如：123456789,987654321</small>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="fas fa-play me-1"></i> 激活
                                    </button>
                                </div>
                            </form>
                            
                            <form action="{{ url_for('dyno.deactivate_bot', bot_id=bot.id) }}" method="post" class="mt-2">
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="fas fa-stop me-1"></i> 停用
                                </button>
                            </form>
                            
                            <div class="mt-3 bot-info-container" data-bot-id="{{ bot.id }}">
                                {% if bot.status == 'online' %}
                                <div class="alert alert-success">
                                    <strong>机器人信息:</strong> 
                                    <span class="bot-name">加载中...</span>
                                </div>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-center my-4">您尚未为任何群组配置机器人</p>
                    {% endif %}
                    
                    <!-- 创建新群组机器人 -->
                    {% if user_groups %}
                    <div class="mt-4">
                        <h5><i class="fas fa-plus me-2"></i> 为群组添加机器人</h5>
                        <form action="{{ url_for('dyno.activate_bot') }}" method="post">
                            <div class="mb-3">
                                <label class="form-label">选择群组</label>
                                <select name="group_id" class="form-select" required>
                                    <option value="">请选择群组</option>
                                    {% for group in user_groups %}
                                    <option value="{{ group.id }}">{{ group.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">机器人令牌</label>
                                <div class="input-group">
                                    <input type="password" class="form-control token-input" name="bot_token" placeholder="输入Discord机器人令牌" required>
                                    <button type="button" class="btn btn-outline-secondary toggle-password">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">频道设置 <small class="text-muted">(可选，留空表示所有频道)</small></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" name="channel_ids" id="channel_ids_group_new" placeholder="输入频道ID，多个ID用逗号分隔">
                                    <div class="selected-channels-display form-text"></div>
                                    <button type="button" class="btn btn-outline-secondary select-channels-btn" data-target="channel_ids_group_new">
                                        <i class="fas fa-list"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <small>例如：123456789,987654321</small>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i> 创建并激活机器人
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i> 帮助信息</h5>
                </div>
                <div class="card-body">
                    <h5>如何获取机器人令牌？</h5>
                    <ol>
                        <li>访问 <a href="https://discord.com/developers/applications" target="_blank">Discord开发者门户</a></li>
                        <li>点击 "New Application" 创建一个新应用</li>
                        <li>为应用命名并创建</li>
                        <li>在左侧菜单选择 "Bot"</li>
                        <li>点击 "Add Bot"</li>
                        <li>在TOKEN部分，点击 "Copy" 复制Bot令牌</li>
                    </ol>
                    
                    <h5>如何邀请机器人到服务器？</h5>
                    <ol>
                        <li>在开发者门户的应用页面，选择 "OAuth2" -> "URL Generator"</li>
                        <li>在 "SCOPES" 部分选择 "bot" 和 "applications.commands"</li>
                        <li>在 "BOT PERMISSIONS" 部分选择需要的权限（建议选择 "Administrator"）</li>
                        <li>复制生成的URL并在浏览器中打开</li>
                        <li>选择要邀请机器人的服务器，并授权</li>
                    </ol>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i> <strong>注意:</strong> 请妥善保管机器人令牌，不要泄露给他人！
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 频道选择 Modal -->
<div class="modal fade" id="channelSelectModal" tabindex="-1" aria-labelledby="channelSelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="channelSelectModalLabel">选择频道</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>当前已选择 <span id="selectedCount" class="badge bg-primary">0</span> 个频道</h6>
                </div>
                
                <div id="serverListContainer" class="card p-3 mb-3">
                    <h6 class="mb-3">Discord服务器</h6>
                    <div id="serverList">
                        <p>选择一个机器人并点击频道选择按钮加载服务器列表</p>
                    </div>
                </div>
                
                <div id="channelContainer" class="card p-3">
                    <h6 class="mb-3">频道列表</h6>
                    <div class="channels-header mb-2">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" id="selectAllBtn">
                            <i class="fas fa-check-square me-1"></i> 全选
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllBtn">
                            <i class="fas fa-square me-1"></i> 取消全选
                        </button>
                    </div>
                    <div id="channelCheckboxes" class="mt-3">
                        <p>请先选择一个服务器查看频道列表</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmChannelSelectionBtn">确认选择</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 全局变量
    let channelSelectModal = null;
    let currentInputField = null;
    let selectedChannels = {};
    
    // 更新已选频道数量
    function updateSelectedCount() {
        const countElement = document.getElementById('selectedCount');
        if (countElement) {
            countElement.textContent = Object.keys(selectedChannels).length;
        }
    }
    
    // 安全获取DOM元素，避免NULL错误
    function safeGetElement(id) {
        const element = document.getElementById(id);
        if (!element) {
            console.warn(`找不到元素: ${id}`);
        }
        return element;
    }
    
    // 安全添加事件监听器
    function safeAddEventListener(element, event, handler) {
        if (element) {
            element.addEventListener(event, handler);
            return true;
        } else {
            console.warn('无法为空元素添加事件监听器');
            return false;
        }
    }
    
    // 安全设置元素HTML内容
    function safeSetInnerHTML(element, html) {
        if (element) {
            element.innerHTML = html;
            return true;
        } else {
            console.warn('无法为空元素设置HTML内容');
            return false;
        }
    }
</script>

<script>
    // 确保在window load时初始化所有事件
    window.addEventListener('load', function() {
        console.log('DOM加载完成，初始化所有功能');
        
        // 初始化模态框（使用安全函数）
        const modalElement = safeGetElement('channelSelectModal');
        if (modalElement) {
            console.log('找到模态框元素，初始化中...');
            // 初始化模态框
            try {
                channelSelectModal = new bootstrap.Modal(modalElement);
                console.log('模态框初始化成功');
            } catch (error) {
                console.error('模态框初始化失败:', error);
            }
        } else {
            console.error('找不到模态框元素!');
        }
        
        // 初始化显示已选频道数量
        const selectedCountElement = safeGetElement('selectedCount');
        if (selectedCountElement) {
            selectedCountElement.textContent = '0';
        }
        
        // 初始化频道选择按钮事件
        initChannelSelectionButtons();
        
        // 初始化全选/取消全选按钮
        initSelectionButtons();
        
        // 初始化确认选择按钮
        initConfirmButton();
        
        // 加载在线机器人信息
        loadAllBotInfo();
    });
    
    // 初始化频道选择按钮
    function initChannelSelectionButtons() {
        const buttons = document.querySelectorAll('.select-channels-btn');
        if (!buttons || buttons.length === 0) {
            console.warn('找不到频道选择按钮');
            return;
        }
        
        console.log(`找到 ${buttons.length} 个频道选择按钮`);
        
        buttons.forEach(button => {
            if (!button) return;
            
            console.log('给频道选择按钮添加事件绑定:', button);
            
            // 使用onclick而不是addEventListener，更可靠
            button.onclick = function(e) {
                console.log('频道选择按钮被点击');
                e.preventDefault();
                
                if (!channelSelectModal) {
                    console.error('模态框未初始化!');
                    alert('系统错误: 无法打开频道选择窗口');
                    return;
                }
                
                // 重置选中频道
                selectedChannels = {};
                
                // 获取机器人ID和目标输入字段
                const botId = this.getAttribute('data-bot-id');
                const targetField = this.getAttribute('data-target');
                
                console.log('选择频道, botId:', botId, '目标字段:', targetField);
                
                if (!targetField) {
                    console.error('按钮缺少data-target属性');
                    return;
                }
                
                currentInputField = safeGetElement(targetField);
                
                if (!currentInputField) {
                    console.error('目标字段未找到:', targetField);
                    return;
                }
                
                // 获取当前机器人的令牌
                let tokenInput = document.querySelector(`input[name="bot_token"][id="bot_token_${botId}"]`); 
                if (!tokenInput) {
                    tokenInput = document.querySelector(`input[name="bot_token"][data-bot-id="${botId}"]`);
                }
                
                if (!tokenInput) {
                    console.error('找不到机器人令牌输入字段, botId:', botId);
                    alert('找不到机器人令牌输入字段');
                    return;
                }
                
                const token = tokenInput.value.trim();
                if (!token) {
                    alert('请先输入机器人令牌');
                    return;
                }
                
                // 如果有已选择的频道，尝试解析并选中
                if (currentInputField.value) {
                    try {
                        const savedChannels = currentInputField.value.split(',');
                        savedChannels.forEach(id => {
                            id = id.trim();
                            if (id) {
                                selectedChannels[id] = true;
                            }
                        });
                        updateSelectedCount();
                    } catch (error) {
                        console.error('解析已保存的频道ID失败:', error);
                    }
                }
                
                // 清空服务器列表
                const serverListElement = safeGetElement('serverList');
                if (serverListElement) {
                    safeSetInnerHTML(serverListElement, `
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">正在获取Discord服务器列表...</p>
                        </div>
                    `);
                }
                
                // 打开模态框
                try {
                    channelSelectModal.show();
                } catch (error) {
                    console.error('显示模态框失败:', error);
                    alert('无法打开频道选择窗口，请刷新页面重试');
                    return;
                }
                
                // 获取Discord服务器列表
                fetchDiscordGuilds(token);
            };
        });
    }
    
    // 初始化全选/取消全选按钮
    function initSelectionButtons() {
        const selectAllBtn = safeGetElement('selectAllBtn');
        if (selectAllBtn) {
            safeAddEventListener(selectAllBtn, 'click', function() {
                document.querySelectorAll('input[name="channel_id"]').forEach(checkbox => {
                    checkbox.checked = true;
                    selectedChannels[checkbox.value] = true;
                });
                updateSelectedCount();
            });
        }
        
        const deselectAllBtn = safeGetElement('deselectAllBtn');
        if (deselectAllBtn) {
            safeAddEventListener(deselectAllBtn, 'click', function() {
                document.querySelectorAll('input[name="channel_id"]').forEach(checkbox => {
                    checkbox.checked = false;
                    delete selectedChannels[checkbox.value];
                });
                updateSelectedCount();
            });
        }
    }
    
    // 初始化确认选择按钮
    function initConfirmButton() {
        const confirmBtn = safeGetElement('confirmChannelSelectionBtn');
        if (confirmBtn) {
            safeAddEventListener(confirmBtn, 'click', function() {
                if (currentInputField) {
                    const channelIds = Object.keys(selectedChannels);
                    currentInputField.value = channelIds.join(',');
                    console.log('已保存选择的频道IDs:', channelIds);
                }
                
                try {
                    channelSelectModal.hide();
                } catch (error) {
                    console.error('关闭模态框失败:', error);
                }
            });
        } else {
            console.error('找不到确认选择按钮');
        }
    }
    
    // 加载所有机器人信息
    function loadAllBotInfo() {
        document.querySelectorAll('.bot-info-container').forEach(container => {
            if (container) {
                const botId = container.getAttribute('data-bot-id');
                if (botId) {
                    fetchBotInfo(botId, container);
                }
            }
        });
    }
    
    // 获取机器人信息
    function fetchBotInfo(botId, container) {
        if (!botId) return;
        
        console.log('获取机器人信息, bot_id:', botId);
        
        const botNameElement = container.querySelector('.bot-name');
        if (!botNameElement) {
            console.error('找不到机器人名称元素');
            return;
        }
        
        // 设置加载状态
        botNameElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载中...';
        
        fetch('/api/v1/bot/info', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ bot_id: botId })
        })
        .then(response => {
            console.log('机器人信息API响应状态:', response.status);
            return response.json();
        })
        .then(data => {
            if (data.success) {
                botNameElement.textContent = data.name || '未知';
                console.log('机器人信息加载成功:', data.name);
            } else {
                botNameElement.textContent = '加载失败';
                console.error('加载机器人信息失败:', data.error);
            }
        })
        .catch(error => {
            console.error('获取机器人信息错误:', error);
            botNameElement.textContent = '加载失败';
        });
    }
</script>

<script>
    // 获取Discord服务器列表
    function fetchDiscordGuilds(token) {
        console.log('开始获取服务器列表');
        
        if (!token) {
            console.error('令牌为空，无法获取服务器');
            const serverList = safeGetElement('serverList');
            if (serverList) {
                safeSetInnerHTML(serverList, `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> 错误：未提供机器人令牌
                    </div>
                `);
            }
            return;
        }
        
        // 添加Bot前缀（如果没有）
        if (!token.startsWith('Bot ')) {
            token = 'Bot ' + token;
        }
        
        // 记录API请求的详细信息以便调试
        console.log('请求URL：/api/v1/discord/guilds');
        console.log('请求方法：POST');
        console.log('请求格式：application/x-www-form-urlencoded');
        console.log('令牌长度：', token.length);
        
        // 用x-www-form-urlencoded格式发送请求
        fetch('/api/v1/discord/guilds', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `token=${encodeURIComponent(token)}`
        })
        .then(response => {
            console.log('服务器列表API响应状态:', response.status);
            if (!response.ok) {
                throw new Error(`服务器响应错误: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('服务器列表获取成功, 条目数:', data.guilds ? data.guilds.length : 0);
            
            // 使用安全函数获取元素
            const serverList = safeGetElement('serverList');
            if (!serverList) {
                console.error('找不到serverList元素');
                return;
            }
            
            if (data.success && data.guilds && data.guilds.length > 0) {
                // 清空现有内容
                safeSetInnerHTML(serverList, '');
                
                // 添加说明文字
                const instructionElement = document.createElement('p');
                instructionElement.className = 'mb-3';
                instructionElement.textContent = '请选择一个服务器以查看其频道:';
                serverList.appendChild(instructionElement);
                
                // 添加服务器选项
                data.guilds.forEach(guild => {
                    const guildItem = document.createElement('div');
                    guildItem.className = 'form-check mb-2';
                    
                    const radioInput = document.createElement('input');
                    radioInput.className = 'form-check-input';
                    radioInput.type = 'radio';
                    radioInput.name = 'guild_id';
                    radioInput.id = `guild_${guild.id}`;
                    radioInput.value = guild.id;
                    
                    const label = document.createElement('label');
                    label.className = 'form-check-label';
                    label.htmlFor = `guild_${guild.id}`;
                    label.textContent = guild.name;
                    
                    guildItem.appendChild(radioInput);
                    guildItem.appendChild(label);
                    serverList.appendChild(guildItem);
                    
                    // 为每个服务器添加点击事件
                    radioInput.onclick = function() {
                        if (this.checked) {
                            console.log('选择服务器:', guild.name, 'ID:', guild.id);
                            const channelCheckboxes = safeGetElement('channelCheckboxes');
                            if (channelCheckboxes) {
                                safeSetInnerHTML(channelCheckboxes, `<p class="text-center my-3">正在加载频道列表...</p>`);
                                fetchDiscordChannels(guild.id, token);
                            }
                        }
                    };
                });
                
                // 添加"获取频道"按钮
                const getChannelsBtn = document.createElement('button');
                getChannelsBtn.className = 'btn btn-primary mt-3';
                getChannelsBtn.textContent = '获取所选服务器的频道';
                getChannelsBtn.onclick = function() {
                    const selectedGuild = document.querySelector('input[name="guild_id"]:checked');
                    if (!selectedGuild) {
                        alert('请先选择一个服务器');
                        return;
                    }
                    
                    const guildId = selectedGuild.value;
                    console.log('手动获取频道，服务器ID:', guildId);
                    
                    const channelCheckboxes = safeGetElement('channelCheckboxes');
                    if (channelCheckboxes) {
                        safeSetInnerHTML(channelCheckboxes, `<p class="text-center my-3">正在加载频道列表...</p>`);
                        fetchDiscordChannels(guild.id, token);
                    }
                };
                
                serverList.appendChild(getChannelsBtn);
                
            } else {
                console.error('获取服务器列表失败或无可用服务器:', data.error || '未知错误');
                
                safeSetInnerHTML(serverList, `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i> ${data.error || '未找到可用的Discord服务器'}
                    </div>
                    <p>请确保：</p>
                    <ul>
                        <li>您的机器人令牌有效</li>
                        <li>机器人已被添加到至少一个Discord服务器</li>
                        <li>机器人拥有查看服务器的权限</li>
                    </ul>
                `);
            }
        })
        .catch(error => {
            console.error('获取服务器列表错误:', error);
            
            const serverList = safeGetElement('serverList');
            if (serverList) {
                safeSetInnerHTML(serverList, `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> 获取服务器列表失败: ${error.message || '未知错误'}
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="retryGuildsBtn">
                            <i class="fas fa-sync me-1"></i> 重试
                        </button>
                    </div>
                `);
                
                // 添加重试按钮事件
                const retryBtn = document.getElementById('retryGuildsBtn');
                if (retryBtn) {
                    retryBtn.onclick = function() {
                        fetchDiscordGuilds(token);
                    };
                }
            }
        });
    }
</script>

<script>
    // 获取Discord频道列表
    function fetchDiscordChannels(guildId, token) {
        const channelCheckboxes = safeGetElement('channelCheckboxes');
        if (!channelCheckboxes) {
            console.error('找不到channelCheckboxes元素');
            return;
        }
        
        console.log('正在获取频道列表，服务器ID:', guildId);
        console.log('令牌长度:', token.length);
        safeSetInnerHTML(channelCheckboxes, `
            <div class="text-center my-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载频道列表...</p>
            </div>
        `);
        
        // 确保令牌格式正确（移除可能的多余空格）
        token = token.trim();
        
        // 通过后端获取频道列表
        console.log('发送API请求到:', '/api/v1/discord/channels');
        fetch('/api/v1/discord/channels', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `token=${encodeURIComponent(token)}&guild_id=${encodeURIComponent(guildId)}`
        })
        .then(response => {
            console.log('频道列表API响应状态:', response.status);
            if (!response.ok) {
                throw new Error(`API响应错误: HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('获取频道列表结果:', data.success ? '成功' : '失败');
            console.log('返回的频道数量:', data.channels ? data.channels.length : 0);
            
            if (data.success) {
                // 清空频道容器
                safeSetInnerHTML(channelCheckboxes, '');
                
                if (!data.channels || data.channels.length === 0) {
                    console.log('未收到有效的频道数据');
                    safeSetInnerHTML(channelCheckboxes, `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> 没有可用的文本频道或机器人没有权限查看频道
                        </div>
                        <div class="mt-2">
                            <p>请确保机器人有以下权限：</p>
                            <ul>
                                <li>查看频道 (View Channels)</li>
                                <li>发送消息 (Send Messages)</li>
                                <li>读取消息历史 (Read Message History)</li>
                            </ul>
                        </div>
                    `);
                    return;
                }
                
                // 分类映射，用于按分类整理频道
                const categoryMap = {};
                
                // 首先整理所有频道并按分类分组
                data.channels.forEach(channel => {
                    const parentName = channel.parent_name || '未分类';
                    
                    if (!categoryMap[parentName]) {
                        categoryMap[parentName] = [];
                    }
                    
                    categoryMap[parentName].push(channel);
                });
                
                // 按分类创建频道列表
                const categories = Object.keys(categoryMap).sort();
                
                categories.forEach(category => {
                    // 创建分类标题
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'category-header mt-3 mb-2';
                    categoryHeader.innerHTML = `
                        <h6 class="fw-bold">
                            <i class="fas fa-folder me-1"></i> ${category} 
                            <span class="badge bg-secondary">${categoryMap[category].length}</span>
                        </h6>
                    `;
                    channelCheckboxes.appendChild(categoryHeader);
                    
                    // 添加此分类下的所有频道
                    categoryMap[category].sort((a, b) => a.name.localeCompare(b.name)).forEach(channel => {
                        // 只显示文本频道和公告频道
                        if (channel.type === 0 || channel.type === 5) {
                            const channelDiv = document.createElement('div');
                            channelDiv.className = 'form-check ms-3 mb-2 channel-item';
                            channelDiv.setAttribute('data-category', category);
                            channelDiv.setAttribute('data-channel-name', channel.name.toLowerCase());
                            
                            // 确定适当的图标
                            let channelIcon = 'fas fa-hashtag';
                            if (channel.type === 5) {
                                channelIcon = 'fas fa-bullhorn'; // 公告频道图标
                            }
                            
                            // 检查此频道是否已被选中
                            const isChecked = selectedChannels[channel.id] ? 'checked' : '';
                            
                            channelDiv.innerHTML = `
                                <input class="form-check-input" type="checkbox" name="channel_id" value="${channel.id}" id="channel_${channel.id}" ${isChecked}>
                                <label class="form-check-label" for="channel_${channel.id}">
                                    <i class="${channelIcon} me-1 text-secondary"></i> ${channel.name}
                                </label>
                            `;
                            
                            // 添加复选框变更事件
                            const checkbox = channelDiv.querySelector('input[type="checkbox"]');
                            if (checkbox) {
                                checkbox.onchange = function() {
                                    if (this.checked) {
                                        selectedChannels[this.value] = true;
                                    } else {
                                        delete selectedChannels[this.value];
                                    }
                                    
                                    // 更新选中数量显示
                                    updateSelectedCount();
                                };
                            }
                            
                            channelCheckboxes.appendChild(channelDiv);
                        }
                    });
                });
                
                // 更新已选数量
                updateSelectedCount();
                
                // 重新绑定全选/取消全选按钮
                initSelectionButtons();
                
            } else {
                safeSetInnerHTML(channelCheckboxes, `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> 获取频道失败: ${data.error || '未知错误'}
                    </div>
                `);
            }
        })
        .catch(error => {
            console.error('获取频道发生错误:', error);
            safeSetInnerHTML(channelCheckboxes, `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i> ${error.message || '获取频道时发生错误'}
                </div>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-outline-secondary" id="retryChannelsBtn">
                        <i class="fas fa-sync me-1"></i> 重试
                    </button>
                </div>
            `);
            
            // 添加重试按钮事件
            const retryBtn = document.getElementById('retryChannelsBtn');
            if (retryBtn) {
                retryBtn.onclick = function() {
                    fetchDiscordChannels(guildId, token);
                };
            }
        });
    }
</script>
{% endblock %}
